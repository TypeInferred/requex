<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/reducers/linked-list-reducer.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/TypeInferred/requex" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~Reduce.html">Reduce</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/linked-list.js~LinkedList.html">LinkedList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/option.js~Option.html">Option</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducer-builder.js~ReducerBuilder.html">ReducerBuilder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducer-context.js~ReducerContext.html">ReducerContext</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducer-query.js~ReducerQuery.html">ReducerQuery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LinkedList">LinkedList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Option">Option</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-CollectionConfiguration">CollectionConfiguration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-NewState">NewState</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PreviousState">PreviousState</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">reducers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/any-event-reducer.js~AnyEventReducer.html">AnyEventReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/event-reducer.js~EventReducer.html">EventReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/filtered-reducer.js~FilteredReducer.html">FilteredReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/flat-reduced-reducer.js~FlatReducedReducer.html">FlatReducedReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/folding-reducer.js~FoldingReducer.html">FoldingReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/linked-list-reducer.js~LinkedListReducer.html">LinkedListReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/mapped-reducer.js~MappedReducer.html">MappedReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/never-reducer.js~NeverReducer.html">NeverReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/reducer.js~Reducer.html">Reducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/scoped-reducer.js~ScopedReducer.html">ScopedReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/structure-reducer.js~StructureReducer.html">StructureReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/reducers/value-reducer.js~ValueReducer.html">ValueReducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ADDITION_SOURCE">ADDITION_SOURCE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ARGS_PREFIX">ARGS_PREFIX</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-INNER_SOURCE">INNER_SOURCE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-REMOVAL_SOURCE">REMOVAL_SOURCE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ROOT">ROOT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SOURCE">SOURCE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VALUE">VALUE</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/reducers/linked-list-reducer.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import Reducer from &apos;./reducer.js&apos;;
import Option from &apos;../option.js&apos;;
import LinkedList from &apos;../linked-list.js&apos;;
import NeverReducer from &apos;./never-reducer.js&apos;;
import {ADDITION_SOURCE, REMOVAL_SOURCE, ARGS_PREFIX} from &apos;./storage-keys.js&apos;;

/**
 * Returns the single object wrapped in an array or the array if the argument is an array.
 * @param {T|Array&lt;T&gt;} itemOrArray - The item or array of items
 * @return {Array&lt;T&gt;} An array of items
 */
const asArray = itemOrArray =&gt;
  itemOrArray instanceof Array ? itemOrArray : [itemOrArray];

/**
 * &lt;b&gt;INTERNAL&lt;/b&gt;
 * A reducer of linked lists that may itself contain reducers.
 */
export default class LinkedListReducer extends Reducer {

  /**
   * Builds a reducer that creates of a linked list from a reducer for additions, a reducer for removals, a function to construct
   * items and a function to extract the key from a constructed item. Keys are used for removal and addressing the auxillary
   * state to ensure accumulators are seeded correctly etc.
   * @param  {CollectionConfiguration} configuration - the configuration needed to build the list
   */
  constructor(configuration) {
    super();
    const {additions, itemFactory, itemKey} = configuration;
    const removals = configuration.removals &amp;&amp; configuration.removals.unwrap() || new NeverReducer();
    this._additionSource = additions.unwrap();
    this._removalSource = removals;
    this._keySelector = itemKey;
    this._elementSelector = itemFactory;
  }

  /** @ignore */
  reduce(context) {
    const previous = context.getPreviousReduction();
    const removals = context.getValue(REMOVAL_SOURCE, this._removalSource);
    const additions = context.getValue(ADDITION_SOURCE, this._additionSource);
    let hasChanged = previous.isNone;

    const existingItems = previous.otherwise(LinkedList.nil());
    let items = existingItems;

    // REMOVE
    if (removals.isSome) {
      hasChanged = true;
      const removedKeys = asArray(removals.get());
      items = LinkedList.filter(items, x =&gt; {
        const key = this._keySelector(x);
        return !removedKeys.includes(key);
      });
    }

    // UPDATE REMAINING
    items = LinkedList.map(items, x =&gt; {
      const key = this._keySelector(x);
      const reducerArgs = context.getStoredValue(ARGS_PREFIX + key);
      context.storeValue(ARGS_PREFIX + key, reducerArgs); // Keep for next time.
      const reducer = this._elementSelector(reducerArgs);
      let newValue = x;
      // If it is a reducer we reduce the new value.
      if (reducer.unwrap) {
        const reducedValue = context.getValue(key, reducer.unwrap());
        hasChanged = hasChanged || reducedValue.isSome;
        newValue = reducedValue.otherwise(x);
      }
      return newValue;
    });

    // ADD + SEED NEW
    if (additions.isSome) {
      hasChanged = true;
      items = asArray(additions.get()).reduce((acc, reducerArgs) =&gt; {
        const reducerOrValue = this._elementSelector(reducerArgs);
        let value;
        let key; 
        if (reducerOrValue.unwrap) {
          const reducedValue = context.getFreshValue(&apos;temp&apos;, reducerOrValue.unwrap());
          value = reducedValue.get();
          key = this._keySelector(value);
          // Move storage to under actual key. TODO: refactor this.
          context.getValue(key, {reduce: () =&gt; reducedValue});
        } else {
          value = reducerOrValue;
          key = this._keySelector(value);
        }
        context.storeValue(ARGS_PREFIX + key, reducerArgs); // Keep for next time.
        return LinkedList.cons(value, acc);
      }, items);
    }

    return hasChanged ? Option.some(items) : Option.none();
  }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.0)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
